<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>Squid - outrunJ笔记</title>
  <meta property="og:title" content="Squid - outrunJ笔记" />
  <meta name="twitter:title" content="Squid - outrunJ笔记" />
  <meta name="description" content="配置文件  /etc/squid/squid.conf  代理类型  普通代理 透明代理 反向代理  缓存  动态资源 静态资源  参考资料  squid 透明代理详解  配置 # squid.conf http_port 3128 # squid服务端口 icp_port 3130 # udp端口,用来接收和发送ICP消息 cache_dir ufs /var/spool/squid # 缓存目录, 写入方式有aufs与ufs两种,aufs使用大量线程异步进行磁盘i/o操作 cache_access_log /var/log/squid/access.log cache_log /var/log/squid/cache.log cache_store_log /var/log/squid/store.log pid_filename /var/run/squid.pid # 日志文件位置 #auth_param basic children 5 #auth_param basic realm Squid proxy-caching web server #auth_param basic credentialsttl 2 hours # 关闭认证，认证一般不需要 cache_effective_user squid cache_effective_group squid cache_mgr youraccount@your.">
  <meta property="og:description" content="配置文件  /etc/squid/squid.conf  代理类型  普通代理 透明代理 反向代理  缓存  动态资源 静态资源  参考资料  squid 透明代理详解  配置 # squid.conf http_port 3128 # squid服务端口 icp_port 3130 # udp端口,用来接收和发送ICP消息 cache_dir ufs /var/spool/squid # 缓存目录, 写入方式有aufs与ufs两种,aufs使用大量线程异步进行磁盘i/o操作 cache_access_log /var/log/squid/access.log cache_log /var/log/squid/cache.log cache_store_log /var/log/squid/store.log pid_filename /var/run/squid.pid # 日志文件位置 #auth_param basic children 5 #auth_param basic realm Squid proxy-caching web server #auth_param basic credentialsttl 2 hours # 关闭认证，认证一般不需要 cache_effective_user squid cache_effective_group squid cache_mgr youraccount@your.">
  <meta name="twitter:description" content="配置文件  /etc/squid/squid.conf  代理类型  普通代理 透明代理 反向代理  缓存  动态资源 静态资源  参考资料  squid 透明代理详解  配置 # squid.conf http_port 3128 # squid服务端口 icp_port 3130 # udp端口,用来接收和发送ICP消息 cache_dir ufs /var/spool/squid # 缓存目 …">
  <meta name="author" content="outrunJ"/>
  <meta property="og:site_name" content="outrunJ笔记" />
  <meta property="og:url" content="http://shenwenqing.com/series/architecture/squid/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.49-DEV" />
  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />
  <script src="/js/jquery-3.3.1.min.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">outrunJ笔记</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-tags"><a href="/tags/" title="Tags">Tags</a></li>
      <li class="site-navi-item-archives"><a href="/archives/" title="Archives">Archives</a></li>
      <li class="site-navi-item-about"><a href="/about/" title="About">About</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">Squid</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>October 11, 2018</time></li>
      </ul>
      
      

<h1 id="配置文件">配置文件</h1>

<pre><code>    /etc/squid/squid.conf
</code></pre>

<h1 id="代理类型">代理类型</h1>

<pre><code>    普通代理
    透明代理
    反向代理
</code></pre>

<h1 id="缓存">缓存</h1>

<pre><code>    动态资源
    静态资源
</code></pre>

<h1 id="参考资料">参考资料</h1>

<pre><code>    squid 透明代理详解
</code></pre>

<h1 id="配置">配置</h1>

<pre><code># squid.conf
http_port 3128                                                # squid服务端口
icp_port 3130                                                # udp端口,用来接收和发送ICP消息
cache_dir ufs /var/spool/squid                                # 缓存目录, 写入方式有aufs与ufs两种,aufs使用大量线程异步进行磁盘i/o操作
cache_access_log /var/log/squid/access.log 
cache_log /var/log/squid/cache.log 
cache_store_log /var/log/squid/store.log 
pid_filename /var/run/squid.pid                        # 日志文件位置

#auth_param basic children 5 
#auth_param basic realm Squid proxy-caching web server 
#auth_param basic credentialsttl 2 hours                 # 关闭认证，认证一般不需要

cache_effective_user squid 
cache_effective_group squid  
cache_mgr youraccount@your.e.mail                        # 设置squid用户及用户组、管理员账号

cache_mem 128 MB                                        # 运行内存配置

cache_swap_low 90 
cache_swap_high 95 
maximum_object_size 4096 KB                        ＃ 与磁盘容量相关的配置，90、95为百分比，磁盘大时4096 KB可以改成32768 KB

maximum_object_size_in_memory 8 KB                ＃ 内存缓存资料大小

以下为定义acl(访问控制列表)
        ＃ 语法为:acl&lt;acl&gt; &lt;acl名称&gt; &lt;acl类型&gt; &lt;配置的内容&gt; 
acl All src 0/0  
acl Manager proto cache_object  acl Localhost src 127.0.0.1/32  
acl Safe_ports port 80 21 443 563 70 210 280 488 591 777 1025-65535
acl SSL_ports 443 563  
acl CONNECT method CONNECT  
acl MyNetwork src 192.168.0.0/16  

以下为利用前面定义的acl,定义访问控制规则
http_access allow Manager Localhost 
http_access deny Manager 
http_access deny !Safe_ports 
http_access deny CONNECT SSL_ports 
http_access allow MyNetwork 
http_access deny All

例子: 禁止访问sina
acl sina dstdomain .sina.com.cn .sina.com 
http_access deny sina 
或 
acl sina dst 58.63.236.26 58.63.236.27 58.63.236.28 58.63.236.29 58.63.236.30 58.63.236.31 58.63.236.32 58.63.236.33 58.63.236.34 58.63.236.35 58.63.236.36 58.63.236.37 58.63.236.38 58.63.236.39 58.63.236.49 58.63.236.50 
http_access deny sina 
或 
acl sina dst www.sina.com.cn 
http_access deny sina

例子: 禁止来自某些ip的访问
acl zhang src 192.168.63.6/32 
http_access deny zhang

例子: 禁止在某些时段访问 
acl Working_hours MTWHF 08:00-17:00 
http_access allow Working_hours 
http_access deny !Working_hours

例子: 禁止某个代理客户建立过多连接  
acl OverConnLimit maxconn 
http_access deny OverConnLimit

定义与其它代理服务器的关系,语法: &lt;cache_peer&gt; &lt;主机名称&gt; &lt;类别&gt; &lt;http_port&gt; &lt;icp_port&gt; &lt;其它参数&gt; 
cache_peer 192.168.60.6 parent 4480 7 no-query default

#设置与其它代理服务器的关系: &lt;cache_peer_access&gt; &lt;上层 Proxy &gt; &lt;allow|deny&gt; &lt;acl名称&gt; 
#cache_peer_access 192.168.60.6 allow aclxxx  
#cache_peer_access 192.168.60.6 deny !aclxxx
coredump_dir /var/spool/squid                                        # 崩溃存储目录
</code></pre>

<h1 id="使用">使用</h1>

<pre><code>step1 检查配置文件
        squid -k parse                                
step2  初始化cache 目录
        squid -z(X)                                # X会显示过程
step3 启动squid
        service squid start
        或
        /usr/local/squid/sbin/squid -sD

停止squid
        squid -k shutdown

重新载入配置
        squid -k reconfigure

滚动日志
        squid -k rotate
                # 
</code></pre>

<h1 id="案例">案例</h1>

<pre><code>透明代理
    step1 检查配置文件
            squid -k parse                                
    step2  初始化cache 目录
            squid -z(X)                                # X会显示过程
    step3 启动squid
            service squid start
            或
            /usr/local/squid/sbin/squid -sD

    停止squid
            squid -k shutdown

    重新载入配置
            squid -k reconfigure

    滚动日志
            squid -k rotate
                    # 
代理
    squid.conf
            http_port 3128
            http_access allow all
            或
            http_port 3128
            http_access deny all前面添加
            acl 192.168.0.42 src 192.168.0.0/24
            http_access allow 192.168.0.42                        ＃ 192.168.0.42为允许的ip
</code></pre>

    </article>

    
<ul class="article-share">
  <li>
    <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </li>
  <li>
    <div class="fb-share-button" data-href="http://shenwenqing.com/series/architecture/squid/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="true"></div>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.10";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  </li>
  <li>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <g:plus action="share"></g:plus>
  </li>
  <li>
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
  <li>
    <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="en"></a>
    <script>!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
  </li>
</ul>


    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="/series/architecture/nginx/" data-toggle="tooltip" data-placement="top" title="Nginx">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="/series/db/mycat/" data-toggle="tooltip" data-placement="top" title="Mycat">Older &gt;</a>
      </li>
    </ul>
  </div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2017 outrunJ</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-about"><a href="/about/" title="About">About</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/taikii/whiteplain">Whiteplain</a>
  </div>
</div>
<script src="/js/script.js"></script>
<script src="/js/custom.js"></script>


</body>
</html>
